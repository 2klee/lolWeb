<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon"> <!-- 파비콘 -->


    <link rel="stylesheet" th:href="@{/css/dropdowns.css}"/>
    <link rel="stylesheet" th:href="@{/css/main.css}"/>
    <link rel="stylesheet" th:href="@{/css/post.css}"/>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">



    <title>Carry.kr</title> <!-- 타이틀 -->
</head>

<body>
<div id="wrap">
    <!-- 헤더영역 -->
    <header id="header" class="header-area header-transparrent fixed-top">
        <div class="main-header header-sticky">
            <div class="container">
                <div class="row">
                    <div class="col d-flex align-items-center justify-content-center">
                        <!-- 로고 -->
                        <a href="/" class="text-decoration-none"><h1
                                class="yellow-text grape_nuts_font font-weight-bold">carry.kr</h1></a>
                    </div>
                    <!-- 메뉴 -->
                    <nav id="mainNav" class="nav col-9 justify-content-center">
                        <ul class="gnb align-items-center font-weight-bold">
                            <li><a href="#">공지사항</a></li>
                            <li><a href="/simulation">시뮬레이션</a></li>
                            <li><a href="#">아이템순위</a></li>
                            <li><a href="#">프로빌드</a></li>
                            <li><a href="#">커뮤니티</a></li>
                        </ul>
                    </nav>
                    <div id="searching" class="col d-flex align-items-center justify-content-center">

                        <iconify-icon icon="ic:twotone-search" width="30"
                                      height="30"></iconify-icon>
                    </div>
                </div>
            </div>
            <!--서브 메뉴-->
            <div id="sub_nav" class="row" style="margin-top: 0.4rem; border-bottom: solid 1px #000000">
                <div class="col"></div>
                <div class="col nav justify-content-center" style="padding-left : 1rem; gap: 5rem; font-weight: 500">
                    <ul class="align-items-center">
                        <li><a href="#">공지사항</a></li>
                        <li><a href="#">패치노트</a></li>
                    </ul>
                    <ul class="align-items-center">
                        <li><a href="/simulation">시뮬레이션</a></li>
                    </ul>
                    <ul class="align-items-center">
                        <li><a href="#">아이템순위</a></li>
                    </ul>
                    <ul class="align-items-center">
                        <li><a href="#">프로빌드</a></li>
                    </ul>
                    <ul class="align-items-center">
                        <li><a href="/post/list">자유게시판</a></li>
                        <li><a href="#">유머게시판</a></li>
                        <li><a href="#">아이템공유</a></li>
                        <li><a href="#">매드무비</a></li>
                        <li><a href="#">커뮤니티</a></li>
                    </ul>
                </div>
                <div class="col"></div>
            </div>
            <!-- 전체 검색창 띄우기 -->
            <div th:id="searchForm" class="searchForm">
                <form>
                    <table style="height: 180px;">
                        <tr>
                            <td></td>
                        </tr>
                    </table>

                </form>
            </div>
        </div>
    </header>
    <!-- 헤더영역 E -->

    <div style="height: 100px">
        <!--        메뉴영역 공백-->
    </div>

    <!-- 메인영역 -->
    <main id="main" class="container">
        <div class="row col-12">
            <div class="col">
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <strong class="card-title">자유게시판</strong>
                    </div>
                    <div class="card-body p-5">
                        <div class="row flex-column">
                            <div class="col" style="font-size: larger" th:text="${post.title}">
                                <!-- 제목 들어가는 부분 -->
                            </div> <!-- /.col -->
                        </div>
                        <div class="row" style="font-size: 14px;">
                            <!-- 게시물 작성자 닉네임, 아이피, 날짜 표시 영역 -->
                            <div class="col d-flex usercss" style="color: #777777;">
                                <p th:text="${post.nickname}"></p>
                                <p th:text="${post.ipAddress}"></p>
                                <p th:text="${#temporals.format(post.createtime, 'yyyy-MM-dd HH:mm:ss')}"></p> <!-- 작성일 표시 -->
                            </div>
                            <!-- 게시물 조회수, 댓글, 좋아요 표시 영역 -->
                            <div class="col d-flex justify-content-end" style="gap: 10px; color: #777777;">

                                <span>조회수

                                    12328</span>

                                <span id="commentCount">댓글 : 0</span>

                                <span>좋아요
                                    12</span>

                            </div>
                        </div>
                        <div class="row">
                            <div class="col p-5"  style="border-top: solid 1px
                             #e0e0e0;" th:utext="${post.content}">
                                <!-- 게시물 본문 들어가는 영역 -->
                            </div>
                        </div>
                        <div class="row ">
                            <div class="col d-flex justify-content-end align-items-center">
                                500
                                <button class="thumb-up">
                                    <iconify-icon icon="material-symbols:thumb-up-outline" width="50"
                                                  height="50"></iconify-icon>
                                </button>
                            </div>
                            <div class="col d-flex align-items-center">
                                <button class="thumb-up">
                                    <iconify-icon icon="material-symbols:thumb-down-outline" width="50" height="50"></iconify-icon>
                                </button>
                                500
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <button type="button" id="modifyBtn" class="col btn btn-success"
                                    style="font-size: medium">수정
                            </button>
                        </div>
                        <div class="col">
                            <button id="delBtn" class="col btn btn-danger" aria-label="Try me! Example: AJAX request" style="font-size: medium">삭제</button>

                        </div>
                        <div class="col">
                            <a href="/post/list"><button class="col btn btn-info" style="font-size: medium">목록
                            </button></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row col-12">
            <div class="col">
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <strong class="card-title">댓글</strong>
                    </div>
                    <div class="card-body">
                        <!-- 댓글 작성 영역 -->
                        <div class="row d-flex justify-content-center" style="font-size: 13px;">
                            <form id="commentForm" class="col-9 d-flex">
                                <input type="hidden" th:name="postId" id="postId" th:value="${post.id}">
                                <div class="col-2 p-0">
                                    <input type="text" id="nickname" name="nickname" style="padding: 0 2px;
                                    width: 130px; height: 25px; border: solid 1px;
                                    margin-bottom: 5px"
                                           placeholder="닉네임" required>
                                    <input type="password" id="password" name="password" placeholder="비밀번호"
                                           style="padding: 0 2px;width: 130px; height:
                                     25px; border:
                                    solid 1px" required>
                                </div>
                                <div class="col-9" style="padding: 0 0 0 20px">
                                    <textarea id="content" name="content" placeholder="댓글 내용을 입력해 주세요." style="padding: 0 2px; width: 100%;
                                    min-height:
                                    55px; border: solid 1px;" required></textarea>
                                </div>
                                <div class="col-1 text-right" style="padding-left: 0">
                                    <button id="commentButton" class="btn btn-primary" style="width: 100%; height:
                                    55px; font-size: medium">등록</button>
                                </div>
                            </form>
                        </div>
                        <!-- 댓글 목록 영역 -->
                        <div class="row d-flex justify-content-center" style="margin-top: 10px" th:if="${comment}">
                            <div class="col-9 d-flex" th:each="commentInfo,commentIndex : ${comment}">

                                <div class="col-11">
                                    <div class="row" th:text="${commentInfo.comment.content}">
                                        <!-- 댓글 내용 영역-->
                                    </div>
                                    <div class="row d-flex usercss" style="color: #777777; font-size: 13px;
                                        margin-bottom: 20px">
                                        <!-- 댓글 작성자 닉네임, 아이피, 날짜 시간 영역 -->
                                        <p th:text="${commentInfo.comment.nickname}"></p>
                                        <p th:text="${commentInfo.comment.ipAddress}"></p>
                                        <p th:text="${commentInfo.comment.createTime}"></p>
                                        <p>삭제</p>
                                    </div>
                                </div>
                                <div class="col mx-auto">
                                    <!--댓글 좋아요 버튼-->
                                    <div class="row d-flex justify-content-center">
                                        <button type="button" class="likeButton"
                                                data-comment-id="${commentInfo.comment.id}"
                                                th:attr="data-comment-id=${commentInfo.comment.id}"
                                                th:class="${commentInfo.isLiked == true} ? 'likeButton liked' : 'likeButton not-liked'" style="margin-bottom: 0">
                                            <iconify-icon th:unless="${commentInfo.isLiked == true}"
                                                          icon="icon-park-outline:like" width="2rem" height="2rem" style="color: #ff0000"></iconify-icon>
                                            <iconify-icon th:if="${commentInfo.isLiked == true}" icon="icon-park-solid:like" width="2rem" height="2rem" style="color: #ff0000"></iconify-icon>
                                        </button>
                                    </div>
                                    <div class="row d-flex justify-content-center">
                                            <span class="likeCount" style="color: #777777; font-size: 13px;
                                        margin-bottom: 20px"
                                                  th:attr="data-comment-id=${commentInfo.comment.id}">
                                                <!-- 댓글 좋아요 수-->
                                            </span>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>


    <!-- 푸터영역 -->
    <footer id="footer" class="footer-style">
        <div class="copyright">
            copyright &copy; 2023 <a href="https://github.com/su-hak/Avengers" style="color: #fffc57;">Avengers</a> All rights reserved.
        </div>
        <div>
            <span>
                이 사이트는 Riot Games의 보증을 받지 않으며 Riot Games 또는 공식적으로 관련된 사람의 견해나 의견을 반영하지 않습니다.
            </span>
            <span>
                리그 오브 레전드를 제작하거나 관리하는 데 있어 League of Legends 및 Riot Games는 Riot Games의 상표 또는 등록 상표입니다. Inc. 리그 오브 레전드 © Riot Games, Inc.
            </span>

        </div>


    </footer>
    <!-- 푸터영역 E -->
</div>


<!-- 메인영역 E -->


<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
<!--<script src="/js/jquery.sticky.js"></script>-->
<script th:src="@{/js/test.js}"></script> <!-- 모든 기능 이벤트 -->
<script th:src="@{/js/decimal.js}"></script> <!-- 계산식 -->
<script th:src="@{/js/web.js}"></script> <!-- 웹페이지 이벤트 관련 -->

<script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>


<!-- 댓글 등록 코드 -->
<script>
    $("#commentButton").click(function() {
        var nickname = $("#nickname").val();
        var password = $("#password").val();
        var content = $("#content").val();

        // 필수 입력 필드가 비어 있는지 확인
        if (nickname.trim() === '') {
            alert("닉네임을 입력해주세요.");
            return;
        } else if (password.trim() === '') {
            alert("비밀번호를 입력해주세요.");
            return;
        } else if (content.trim() === '') {
            alert("댓글 내용을 입력해주세요.");
            return;
        } else {
            // Ajax를 이용한 비동기적인 댓글 작성
            $.ajax({
                type: "POST",
                url: "/post/createComment",
                contentType: "application/json",
                data: JSON.stringify({
                    postId: $("#postId").val(),
                    nickname: nickname,
                    password: password,
                    content: content
                }),
                success: function(response) {
                    // 성공적으로 댓글이 작성되면 처리할 로직
                    alert("댓글이 성공적으로 저장되었습니다.");
                    location.reload();
                },
                error: function(error) {
                    // 댓글 작성 중 에러 발생 시 처리할 로직
                    alert("댓글 작성에 실패했습니다.");
                }
            });
        }
    });



    // 버튼 클릭 시 createComment 함수 호출하도록 수정
    $(document).ready(function () {
        updateAllCommentsLikeStatus();
        // $("#commentButton").click(createComment);

        // 게시물이 로드될때 게시글의 총 댓글수 반환
        var postId = $("#postId").val(); // 게시글의 ID를 가져옵니다.

        // 게시글의 총 댓글 수를 조회하는 AJAX 요청
        $.ajax({
            type: "GET",
            url: "/post/" + postId + "/commentCount",
            success: function(response) {
                // 성공적으로 총 댓글 수를 가져왔을 때 HTML에 표시
                $("span#commentCount").text("댓글 : " + response);
            },
            error: function(error) {
                console.error("Error:", error);
            }
        });
    });
</script>

<!--수정 관련-->
<!-- 수정 버튼 클릭 시 -->
<script>
    $(document).ready(function () {
        $("#modifyBtn").click(function () {
            Swal.fire({
                title: '비밀번호 입력',
                input: 'password',
                inputPlaceholder: '비밀번호를 입력하세요',
                showCancelButton: true,
                confirmButtonText: '확인',
                cancelButtonText: '취소',
                preConfirm: (password) => {
                    if (!password) {
                        Swal.showValidationMessage('비밀번호를 입력해주세요.');
                    }
                    return password;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    let postId = $("#postId").val(); // 게시글 ID
                    // 비밀번호가 입력되었을 경우에만 수정 페이지로 이동
                    if (result.value) {
                        // 비밀번호 확인을 서버로 요청하여 일치하는지 확인
                        $.ajax({
                            type: "POST",
                            url: "/post/checkPassword",
                            contentType: "application/json",
                            data: JSON.stringify({
                                postId: postId,
                                password: result.value
                            }),
                            success: function (response) {
                                if (response === "true") {
                                    // 비밀번호가 일치하면 수정 페이지로 이동
                                    window.location.href = "/post/modify/" + postId;
                                } else {
                                    // 비밀번호가 일치하지 않는 경우 알림창 표시
                                    Swal.fire({
                                        icon: 'error',
                                        title: '비밀번호가 일치하지 않습니다.',
                                        text: '비밀번호를 다시 입력해주세요.',
                                        confirmButtonText: '확인'
                                    });
                                }
                            },
                            error: function (error) {
                                console.error('Error:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: '오류 발생',
                                    text: '비밀번호 확인 중 오류가 발생했습니다.',
                                    confirmButtonText: '확인'
                                });
                            }
                        });
                    }
                }
            });
        });
    });
</script>



<!--삭제 관련-->
<script>
    $("#delBtn").click(function () {
        Swal.fire({
            title: '비밀번호 입력',
            input: 'password',
            inputPlaceholder: '비밀번호를 입력하세요',
            showCancelButton: true,
            confirmButtonText: '확인',
            cancelButtonText: '취소',
            preConfirm: (password) => {
                if (!password) {
                    Swal.showValidationMessage('비밀번호를 입력해주세요.');
                }
                return password;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                let postId = $("#postId").val(); // 게시글 ID
                console.log(postId);

                // 비밀번호가 입력되었을 경우에만 삭제 요청을 서버로 전송
                fetch(`/post/delete/${postId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: result.value })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(response.statusText);
                        }
                        return response.text();
                    })
                    .then(data => {
                        // 삭제 요청이 성공적으로 처리되었을 때의 처리
                        Swal.fire({
                            icon: 'success',
                            title: '게시글 삭제 완료',
                            text: data,     // PostController의 ResponseEntity.ok 값
                            confirmButtonText: '확인'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                location.href = '/post/list'; // 삭제 성공 시 게시글 목록 페이지로 이동
                            }
                        });
                    })
                    .catch(error => {
                        // 오류 처리
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: '게시글 삭제 실패',
                            text: '게시글 삭제에 실패했습니다.',
                            confirmButtonText: '확인'
                        });
                    });
            }
        });
    });

    // 댓글 삭제 기능
    // 삭제 버튼 클릭 이벤트 핸들러
    $(".delCommentBtn").click(function () {
        console.log("삭제버튼 클릭");
        Swal.fire({
            title: '비밀번호 입력',
            input: 'password',
            inputPlaceholder: '비밀번호를 입력하세요',
            showCancelButton: true,
            confirmButtonText: '확인',
            cancelButtonText: '취소',
            preConfirm: (password) => {
                if (!password) {
                    Swal.showValidationMessage('비밀번호를 입력해주세요.');
                }
                return password;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // 비밀번호가 입력되었을 경우에만 삭제 요청을 서버로 전송
                var postId = $("#postId").val(); // 해당 댓글의 postId를 가져옴
                var commentId = $(this).attr("data-comment-id");

                // 서버로부터 비밀번호 일치 여부 확인 요청을 보냄
                $.ajax({
                    type: 'POST',
                    url: '/post/checkCommentPassword',
                    contentType: 'application/json',
                    data: JSON.stringify({commentId: commentId, password: result.value }),
                    success: function (data) {
                        // 서버로부터의 응답을 받아 처리
                        if (data === "true") {
                            // 비밀번호가 일치할 경우 삭제 요청을 서버로 전송
                            $.ajax({
                                type: 'DELETE',
                                url: '/post/deleteComment/' + commentId,
                                success: function (data) {
                                    // 삭제 요청이 성공적으로 처리되었을 때의 처리
                                    Swal.fire({
                                        icon: 'success',
                                        title: '댓글 삭제 완료',
                                        text: data, // PostController의 ResponseEntity.ok 값
                                        confirmButtonText: '확인'
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            location.reload(); // 삭제 성공 시 페이지 새로고침
                                        }
                                    });
                                },
                                error: function (error) {
                                    // 오류 처리
                                    console.error('Error:', error);
                                    Swal.fire({
                                        icon: 'error',
                                        title: '댓글 삭제 실패',
                                        text: '댓글 삭제에 실패했습니다.',
                                        confirmButtonText: '확인'
                                    });
                                }
                            });
                            console.log(postId, commentId);
                        } else {
                            // 비밀번호가 일치하지 않을 경우 알림 메시지 출력
                            Swal.fire({
                                icon: 'error',
                                title: '비밀번호 오류',
                                text: '입력하신 비밀번호가 일치하지 않습니다.',
                                confirmButtonText: '확인'
                            });
                        }
                    },
                    error: function (error) {
                        // 오류 처리
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: '오류 발생',
                            text: '서버와의 통신 중 오류가 발생했습니다.',
                            confirmButtonText: '확인'
                        });
                    }
                });
            }
        });
    });


    // 좋아요 수 갱신 함수
    function updateLikeCount(commentId) {
        console.log(commentId);
        $.ajax({
            type: "GET",
            url: "/" + commentId + "/like/count",
            success: function(response) {
                console.log("RES::: ",response);
                var likeCountValueElement = $(".likeCount[data-comment-id='" + commentId + "']");
                console.log(likeCountValueElement);

                // response가 0보다 크면 좋아요 수를 업데이트
                if (response > 0) {
                    console.log("좋아요가 존재합니다.");
                    likeCountValueElement.text(""+response+"");
                } else {
                    // 좋아요가 하나도 없으면 0으로 표시
                    console.log("좋아요가 존재하지 않슴둥.");
                    likeCountValueElement.text("0");
                }


            },
            error: function(error) {
                console.log(error);
                alert("좋아요 수 갱신 중 오류가 발생했습니다.");
            }
        });
    }

    // 초기에 모든 댓글에 대해 좋아요 수를 업데이트
    function updateAllCommentsLikeStatus() {
        $(".likeButton").each(function () {
            var likeButton = $(this);
            var commentId = likeButton.attr("data-comment-id");
            updateLikeCount(commentId);
        });
    }
    // 좋아요 버튼 클릭 시 동작
    $(document).on("click", ".likeButton", function() {
        var likeButton = $(this);
        // 타임리프로부터 직접 값을 받아옴
        var commentId = likeButton.attr("data-comment-id");

        $.ajax({
            type: "POST",
            url: "/" + commentId + "/like",
            contentType: "application/json",
            data: JSON.stringify({
                ipAddress: "dummy"
            }),
            success: function(response) {
                // 좋아요 상태에 따라 아이콘 변경
                if (response === true) {
                    likeButton.removeClass("not-liked");
                    likeButton.addClass("liked");
                    likeButton.find('iconify-icon').attr('icon', 'icon-park-solid:like');
                } else {
                    likeButton.removeClass("liked");
                    likeButton.addClass("not-liked");
                    likeButton.find('iconify-icon').attr('icon', 'icon-park-outline:like');
                }

                // 좋아요 수 업데이트
                updateLikeCount(commentId);
            },
            error: function(error) {
                console.log(this.url);
                alert("좋아요 처리 중 오류가 발생했습니다.");
            }
        });
    });
</script>

<!--<script>  // 스크롤을 위로 올리는 스티키바-->
<!--    $(window).on('scroll', function () {-->
<!--        var scroll = $(window).scrollTop();-->
<!--        if (scroll < 245) {-->
<!--            $(".header-sticky").removeClass("sticky-bar");-->
<!--        } else {-->
<!--            $(".header-sticky").addClass("sticky-bar");-->
<!--        }-->
<!--    });-->

<!--    $(window).on('scroll', function () {-->
<!--        var scroll = $(window).scrollTop();-->
<!--        if (scroll < 245) {-->
<!--            $(".header-sticky").removeClass("sticky");-->
<!--        } else {-->
<!--            $(".header-sticky").addClass("sticky");-->
<!--        }-->
<!--    });-->
<!--</script>-->


<!--<script>  //스크롤 내리면 헤더영역 애니메이션-->
<!--    $(window).scroll(function () {-->
<!--        if ($(window).scrollTop() > 100) {-->
<!--            $("#header").addClass("animated");-->
<!--        } else {-->
<!--            $("#header").removeClass('animated');-->
<!--        }-->
<!--    });-->
<!--</script>-->


</body>

</html>